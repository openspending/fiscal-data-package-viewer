{% extends "layouts/embedded.html" %}

{% block content %}
<style>
  .alert {
    display: none;
  !important;
  }

  .container {
    padding: 0px;
  !important;
    margin: 0px;
  !important;
  }
</style>

<div>
  {% if view == 'piechart' %}
  {% raw %}
  <pie-chart cube="{{cube}}" state="params" endpoint="{{apiUrl}}">
  </pie-chart>
  {% endraw %}
  {% endif %}

  {% if view == 'barchart' %}
  {% raw %}
  <chart cube="{{cube}}" type="bar" state="params" endpoint="{{apiUrl}}">
  </chart>
  {% endraw %}
  {% endif %}

  {% if view == 'linechart' %}
  {% raw %}
  <chart cube="{{cube}}" type="line" state="params" endpoint="{{apiUrl}}">
  </chart>
  {% endraw %}
  {% endif %}

  {% if view == 'treemap' %}
  {% raw %}
  <tree-map cube="{{cube}}" state="params" endpoint="{{apiUrl}}"></tree-map>
  {% endraw %}
  {% endif %}

  {% if view == 'bubbletree' %}
  {% raw %}
  <bubbletree cube="{{cube}}" state="params" endpoint="{{apiUrl}}">
  </bubbletree>
  {% endraw %}
  {% endif %}

  {% if view == 'table' %}
  {% raw %}
  <babbage-table cube="{{cube}}" state="params" endpoint="{{apiUrl}}">
  </babbage-table>
  {% endraw %}
  {% endif %}

  {% if view == 'map' %}
  {% raw %}
  <geo-view
    cube="{{cube}}"
    state="params"
    endpoint="{{apiUrl}}"
    cosmo-endpoint="{{cosmoEndpoint}}"
    country-code="{{countryCode}}">
  </geo-view>
  {% endraw %}
  {% endif %}

  {% if view == 'pivottable' %}
  {% raw %}
  <pivot-table
    cube="{{cube}}"
    state="paramsPivot"
    endpoint="{{apiUrl}}"
    cosmo-endpoint="{{cosmoEndpoint}}"
    country-code="{{countryCode}}">
  </pivot-table>
  {% endraw %}
  {% endif %}
</div>

<script>
  var components = require('components');

  var pieDirective = new components.babbage.PieChartDirective();
  var chartDirective = new components.babbage.ChartDirective();
  var treemapDirective = new components.babbage.TreemapDirective();
  var bubbleTreeDirective = new components.babbage.BubbleTreeDirective();
  var tableDirective = new components.babbage.BabbageTableDirective();
  var geoViewDirective = new components.babbage.GeoViewDirective();
  var pivotTableDirective = new components.babbage.PivotTableDirective();

  var embedded = angular.module('Application', []);

  pieDirective.init(embedded);
  chartDirective.init(embedded);
  treemapDirective.init(embedded);
  tableDirective.init(embedded);
  bubbleTreeDirective.init(embedded);
  geoViewDirective.init(embedded);
  pivotTableDirective.init(embedded);

  embedded.controller('EmbeddedCtrl', [
    '$scope', '$q',
    function($scope, $q) {
      $scope.apiUrl = '{{apiUrl | safe}}';
      $scope.cube = '{{cube | safe}}';
      $scope.view = '{{view | safe}}';
      $scope.params = {{ params | safe }};
      $scope.paramsPivot = {{ paramsPivot | safe }};
      $scope.cosmoEndpoint = '{{cosmoUrl | safe}}';

      var api = components.dataPackageApi({url: $scope.apiUrl});
      if ($scope.view == 'map') {
        $q(function(resolve, reject) {
          api.getDataPackage($scope.cube).then(resolve).catch(reject);
        })
        .then(function(packageInfo) {
          $scope.countryCode = _.isArray(packageInfo.countryCode) ?
            _.first(packageInfo.countryCode) : packageInfo.countryCode;
        });
      } else {
        if ($scope.view == 'treemap') {
//          $scope.$on('treemap-click',
//            function(event, treeMapComponent, info) {
//              console.log('++++++++++++++++++++++++++++++++++++++');
//              console.log(treeMapComponent);
//              console.log(info);
//              api.getDataPackageModel($scope.cube).then(function (model) {
//                console.log('*****************');
//                console.log(model);
//                var dimensions = api.getDimensionsFromModel(model);
//
//                var dimension = _.find(
//                  dimensions, {
//                    key: _.first($scope.params.group)
//                  });
//
//                if (dimension && dimension.drillDown) {
//                  console.log('-------------dimension-------------');
//                  console.log(dimension);
//
//                  $scope.params.group = [dimension.drillDown];
//                  var item = _.find(dimension.values, { key: info._key });
//                  console.log(item);
//                  if (item) {
//                    $scope.params.filter[dimension.key] =
//                      item.key;
//                  }
//                }
//              });
//            });//not finished yet
        }
      }
    }
  ]);
</script>

{% endblock %}
